<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Location</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .location-icon {
            font-size: 64px;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            color: var(--tg-theme-hint-color, #999999);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        
        .status-container {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .status-initial {
            background: #e8f4fd;
            color: #0088cc;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            animation: successPulse 2s ease-in-out;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .spinner {
            border: 3px solid rgba(0, 136, 204, 0.2);
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .status-detail {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .action-button {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.2);
        }
        
        .action-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 136, 204, 0.3);
        }
        
        .action-button:active {
            transform: translateY(0);
        }
        
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .retry-button {
            background: transparent;
            color: #0088cc;
            border: 1px solid #0088cc;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .user-info {
            margin-top: 20px;
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .hidden {
            display: none;
        }
        
        .instructions {
            margin-top: 20px;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
        }
        
        .close-button {
            margin-top: 20px;
            background: #6c757d;
            padding: 12px 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="location-icon">üìç</div>
            <h1>Share Your Location</h1>
            <p class="subtitle">Tap the button below to share your current location for job tracking and attendance purposes.</p>
        </div>
        
        <div id="status" class="status-container status-initial">
            <p class="status-text">Ready to share location</p>
            <p class="status-detail">Your location will only be shared when you click the button</p>
        </div>
        
        <button id="shareButton" class="action-button" onclick="requestLocation()">
            üìç Share My Location
        </button>
        
        <button id="closeButton" class="action-button close-button hidden" onclick="closeApp()">
            Close App
        </button>
        
        <div id="userInfo" class="user-info hidden">
            <!-- Telegram user info will appear here -->
        </div>
        
        <div class="instructions">
            <p>üìç Make sure location services are enabled on your device</p>
            <p>üì± Grant location permission when prompted</p>
            <p>‚ö° Your data is sent securely to our system</p>
        </div>
    </div>

    <script>
        // ===================== CONFIGURATION =====================
        const WEBHOOK_URL = 'https://n8n.la-renting.com/webhook/0b58bdb2-bf32-4b48-8a2a-0539359cb88e';
        // =========================================================
        
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        let isProcessing = false;
        
        // Initialize app
        function initApp() {
            console.log('üîß Initializing Telegram Web App');
            
            // Expand to full screen
            tg.expand();
            
            // Set app theme
            tg.setHeaderColor('#0088cc');
            tg.setBackgroundColor('#ffffff');
            
            // Get user data
            const user = tg.initDataUnsafe?.user;
            console.log('üë§ Telegram User:', user);
            
            // Display user info if available
            if (user) {
                const userInfo = document.getElementById('userInfo');
                userInfo.classList.remove('hidden');
                userInfo.innerHTML = `
                    <strong>User:</strong> ${user.first_name} ${user.last_name || ''}<br>
                    <strong>Username:</strong> @${user.username || 'not set'}<br>
                    <strong>ID:</strong> ${user.id}
                `;
            }
            
            console.log('‚úÖ App initialized successfully');
        }
        
        // Request location using Telegram's native API
        async function requestLocation() {
            if (isProcessing) return;
            
            const shareButton = document.getElementById('shareButton');
            const statusDiv = document.getElementById('status');
            
            // Set processing state
            isProcessing = true;
            shareButton.disabled = true;
            shareButton.textContent = 'Getting location...';
            
            // Update UI
            statusDiv.className = 'status-container status-loading';
            statusDiv.innerHTML = `
                <div class="spinner"></div>
                <p class="status-text">Requesting location...</p>
                <p class="status-detail">Please wait while we access your location</p>
            `;
            
            console.log('üìç Starting location request...');
            
            try {
                // Method 1: Try Telegram's native location request first
                if (tg.requestLocation && typeof tg.requestLocation === 'function') {
                    console.log('üì± Using Telegram location API');
                    
                    tg.requestLocation(
                        // Success callback
                        (location) => {
                            console.log('‚úÖ Telegram location received:', location);
                            processAndSendLocation(
                                location.latitude,
                                location.longitude,
                                { accuracy: 50, source: 'telegram_api' }
                            );
                        },
                        // Error callback
                        (error) => {
                            console.warn('‚ö†Ô∏è Telegram location failed:', error);
                            // Fallback to browser geolocation
                            useBrowserGeolocation();
                        }
                    );
                } else {
                    // Method 2: Use browser geolocation if Telegram API not available
                    console.log('üåê Using browser geolocation');
                    useBrowserGeolocation();
                }
            } catch (error) {
                console.error('‚ùå Error in requestLocation:', error);
                useBrowserGeolocation();
            }
        }
        
        // Fallback to browser geolocation
        function useBrowserGeolocation() {
            console.log('üîç Starting browser geolocation...');
            
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your device/browser.');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                // Success handler
                (position) => {
                    console.log('‚úÖ Browser location received:', position.coords);
                    processAndSendLocation(
                        position.coords.latitude,
                        position.coords.longitude,
                        {
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            heading: position.coords.heading,
                            speed: position.coords.speed,
                            source: 'browser_geolocation'
                        }
                    );
                },
                // Error handler
                (error) => {
                    console.error('‚ùå Browser geolocation error:', error);
                    
                    let errorMessage = 'Failed to get location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location permission was denied.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred.';
                    }
                    
                    showError(errorMessage);
                },
                // Options
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }
        
        // Process location and send to webhook
        async function processAndSendLocation(latitude, longitude, additionalData = {}) {
            console.log('üì§ Processing location for sending...');
            
            const statusDiv = document.getElementById('status');
            const shareButton = document.getElementById('shareButton');
            
            // Update UI
            statusDiv.className = 'status-container status-loading';
            statusDiv.innerHTML = `
                <div class="spinner"></div>
                <p class="status-text">Sending location...</p>
                <p class="status-detail">Latitude: ${latitude.toFixed(6)}, Longitude: ${longitude.toFixed(6)}</p>
            `;
            
            // Get user data
            const user = tg.initDataUnsafe?.user;
            
            // Prepare data for webhook
            const locationData = {
                // Telegram user info
                telegram_user_id: user?.id || null,
                telegram_username: user?.username || null,
                telegram_first_name: user?.first_name || null,
                telegram_last_name: user?.last_name || null,
                
                // Location data
                latitude: latitude,
                longitude: longitude,
                accuracy: additionalData.accuracy || 0,
                
                // Additional info
                timestamp: new Date().toISOString(),
                app_version: tg.version || 'unknown',
                platform: tg.platform || 'unknown',
                source: additionalData.source || 'unknown',
                
                // Metadata
                type: 'location_share',
                status: 'success'
            };
            
            console.log('üì¶ Location data prepared:', locationData);
            
            try {
                // Send to webhook
                console.log('üîÑ Sending to webhook:', WEBHOOK_URL);
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(locationData)
                });
                
                const responseText = await response.text();
                console.log('üì• Webhook response:', response.status, responseText);
                
                if (response.ok) {
                    // Success
                    showSuccess('Location shared successfully!');
                    
                    // Hide share button, show close button
                    shareButton.classList.add('hidden');
                    document.getElementById('closeButton').classList.remove('hidden');
                    
                    // Auto-close after 3 seconds
                    setTimeout(() => {
                        tg.close();
                    }, 3000);
                    
                } else {
                    // Server error
                    throw new Error(`Server returned ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error sending to webhook:', error);
                showError(`Failed to send location: ${error.message}`);
            }
        }
        
        // Show success message
        function showSuccess(message) {
            isProcessing = false;
            
            const statusDiv = document.getElementById('status');
            const shareButton = document.getElementById('shareButton');
            
            statusDiv.className = 'status-container status-success';
            statusDiv.innerHTML = `
                <p class="status-text">‚úÖ ${message}</p>
                <p class="status-detail">You can now close this window</p>
            `;
            
            shareButton.disabled = false;
            shareButton.textContent = 'üìç Share My Location';
        }
        
        // Show error message
        function showError(message) {
            isProcessing = false;
            
            const statusDiv = document.getElementById('status');
            const shareButton = document.getElementById('shareButton');
            
            statusDiv.className = 'status-container status-error';
            statusDiv.innerHTML = `
                <p class="status-text">‚ùå ${message}</p>
                <button class="retry-button" onclick="requestLocation()">Try Again</button>
            `;
            
            shareButton.disabled = false;
            shareButton.textContent = 'üìç Share My Location';
        }
        
        // Close the app
        function closeApp() {
            tg.close();
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, initializing app...');
            
            // Check if running in Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                initApp();
            } else {
                // Not in Telegram - show error
                document.getElementById('status').className = 'status-container status-error';
                document.getElementById('status').innerHTML = `
                    <p class="status-text">‚ùå This app only works within Telegram</p>
                    <p class="status-detail">Please open this link from Telegram messenger</p>
                `;
                document.getElementById('shareButton').classList.add('hidden');
            }
        });
        
        // Error handling for uncaught errors
        window.addEventListener('error', function(event) {
            console.error('üî• Uncaught error:', event.error);
            showError('An unexpected error occurred. Please try again.');
        });
    </script>
</body>
</html>
